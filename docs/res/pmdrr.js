// 将Github Pages自动生成的Markdown渲染页面进行自动重绘
// Powered by SoberJS
// 自定义设置项区
const /*文章授权协议*/conf_licen=`AGPL-3.0`;
const /*文章授权协议链接*/conf_licen_link=`https://gitee.com/kdxiaoyi/Pages-md-reRender/blob/master/LICENSE`;
const /*在代码块下方添加复制代码按钮*/conf_codeCopyBtn=true;
const   /*代码块复制按钮默认文本*/conf_codeCopyBtn_tip="Copy";
const   /*代码块复制按钮点击后文本*/conf_codeCopyBtn_tip_done="Copied!";
const /*允许点击图片来查看大图*/conf_imgView=true;
const   /*启用查看大图对imgse图床的自动去除.md.缩略图后缀*/conf_imgView_imgse=true;
const   /*启用查看大图查看原图 跳转至imgse查看页而不是源文件*/conf_imgView_imgse_noRes=true;
const   /*启用查看大图查看原图按钮*/conf_imgView_open=true;
const /*启用建站时长计时 [是否启用t/f,年,月,日]*/conf_time=[false,2024,10,20];
const /*左侧边栏·一言*/conf_saying="一款极其轻量且低侵入的Github Pages主题";
const /*左侧边栏·第1格·背景图片*/conf_sidebar_headimg_src=`https://kdxiaoyi.top/favicon.ico`;
const   /*左侧边栏·第1格·背景图片描述*/conf_sidebar_headimg_alt="Pages-md-reRender";
const /*左侧边栏·第2格内容*/conf_sidebar_links=`
<s-chip id="side_ship_0" onclick="openURL('/','')" clickable="true" class="sidebar_btn">
<s-icon slot="start" type="home"></s-icon>
主页 Homepage</s-chip>
<s-chip id="side_ship_1" onclick="openURL('http://github.com/kdxhub/Pages-md-reRender')" clickable="true" class="sidebar_btn">
<s-icon slot="start"></s-icon>
Github ↗</s-chip>
<s-chip id="side_ship_2" onclick="openURL('https://gitee.com/kdxiaoyi/Pages-md-reRender')" clickable="true" class="sidebar_btn">
<s-icon slot="start"></s-icon>
Gitee ↗</s-chip>`
const /*左侧边栏·第2格内容中没有按文档编写请启用此项*/conf_sidebar_links_preventDefault=false;
const /*复制文本后向文本末尾添加来源出处，为空时禁用
      %LINK% 指代页面链接
      %TITLE% 指代标题  %ETITLE% 指代文章标题  区别在于前者是标题栏的标题，后者是检测到的文章标题
      可以使用${}来引用页面中已有的配置项，例如${conf_licen}可以指代授权协议*/
      conf_copy_endnote=` ‖ 来自[%ETITLE%](%LINK%)，以${conf_licen}协议授权。`;
const /*图片加载失败后的占位符图片*/conf_img_error_replace="https://rs.kdxiaoyi.top/res/images/load_err.svg";
const /*为所有在新标签页打开的链接添加右上箭头*/conf_link_arrow=true;
const   /*仅对含有 ↗ 或 $ 的链接生效*/conf_link_arrow_replace=true;
const   /*外链图标*/conf_link_arrow_icon=`<s-icon class="newWindowOpen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm188-212-56-56 372-372H560v-80h280v280h-80v-144L388-332Z"></path></svg></s-icon>`;

const PluginVer=["1.1.1",15];document.body.innerHTML=`\n\n  \x3c!-- Pages Markdown Re-Render --\x3e\n\n  \x3c!-- 页面重渲染插入代码开始 --\x3e\n\n  <link rel="stylesheet" href="https://rs.kdxiaoyi.top/res/css/sober-theme-turquoise.css" />\n\n  <style>\n\n    html, body, s-page {\n\n      height: 100%;\n\n      overflow: hidden;\n\n      margin: 0;\n\n      -webkit-tap-highlight-color: transparent;\n\n    }\n\n    #contentBG {\n\n      width: 100vw;\n\n      flex-grow:1;\n\n      overflow: auto;\n\n    }\n\n    .sidebar_btn {\n\n      width:100%;\n\n      margin:1% 0 1% 0;\n\n    }\n\n    .sidebar_head {\n\n      width:100%;\n\n      padding: 3px 3px 3px 3px;\n\n      margin-bottom: 3%;\n\n    }\n\n    .page_root {\n\n      width:100%;height:100%;\n\n    }\n\n    @keyframes fadeIn {\n\n      from {opacity: 0;}\n\n      to {opacity: 1;}\n\n      }\n\n    .fadeIn {\n\n      animation-duration: 0.5s;\n\n      animation-fill-mode: both;\n\n      animation-name: fadeIn;\n\n    }\n\n    @keyframes fadeOut {\n\n      from {opacity: 1;}\n\n      to {opacity: 0;}\n\n      }\n\n    .fadeOut {\n\n      animation-duration: 0.5s;\n\n      animation-fill-mode: both;\n\n      animation-name: fadeOut;\n\n    }\n\n    img.processed {\n\n      min-width: 50%;\n\n      max-width: 90%;\n\n      min-height: 50%;\n\n      max-height: 90%;\n\n      margin: 0 auto;\n\n      display: block;\n\n    }\n\n    code.processed {}\n\n    .selectable {user-select:text;}\n\n    s-icon.newWindowOpen {height:1em;width:1em;}\n\n  </style>\n\n  <s-page theme="auto" class="page_root" id="page_root">\n\n    <s-dialog style="display:none;" id="img_dialog" size="full">\n\n      <div style="padding: 24px">\n\n        <p id="img_dialog_p"></p>\n\n        <img data-ui-img="true" id="img_dialog_img" src=""></img>\n\n      </div>\n\n      <s-button id="img_dialog_open_btn" slot="action" type="text">查看原图 <s-icon class="newWindowOpen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm188-212-56-56 372-372H560v-80h280v280h-80v-144L388-332Z"></path></svg></s-icon></s-button>\n\n      <s-button id="img_dialog_btn" slot="action" type="text">关闭</s-button>\n\n    </s-dialog>\n\n    <s-appbar id="appbar">\n\n     \x3c!--左侧菜单按钮--\x3e\n\n      <s-icon-button type="filled-tonal" slot="navigation" onclick='document.getElementById("sidebar").toggle();console.output("切换Sidebar显示");'>\n\n        <s-icon type="menu"></s-icon>\n\n      </s-icon-button>\n\n     \x3c!--标题--\x3e\n\n      <div slot="headline" id="UIt" style="opacity:0;">  </div>\n\n     \x3c!--右侧按钮--\x3e\n\n      <s-icon-button type="outlined" class="fadeOut" style="display:none;" id="toTop" slot="action" onclick="javascript:void(0);"><s-icon type="arrow_upward"></s-icon></s-icon-button>\n\n    </s-appbar>\n\n    <s-drawer id="sidebar">\n\n      <div id="sidebar_left_parent" slot="start">\n\n        <div id="sidebar_left" style="padding:5px 5px 5px 5px;">\n\n          \x3c!--左侧边栏内容--\x3e\n\n          <s-card type="" class="sidebar_head">\n\n            <div slot="image"><img data-ui-img="true" src="${conf_sidebar_headimg_src}"></div>\n\n            <div slot="headline"><span class='sidebar_username_bg'>${conf_sidebar_headimg_alt}</span></div>\n\n          </s-card><br>\n\n          <s-card type="" class="sidebar_head">${conf_sidebar_links}</s-card><br>\n\n          <s-card type="" class="sidebar_head">\n\n            <div id="saying" class="selectable"><center>${conf_saying}</center></div>\n\n            <div id="time"><center><small>Since 2022-07-19</small></center></div>\n\n            <div id="license"><center><small>以<a href="${conf_licen_link}">${conf_licen}</a>协议提供内容</small></center></div>\n\n          </s-card>\n\n        </div>\n\n      </div>\n\n      <div>\n\n        <s-scroll-view id="contentScroll" style="max-height:100%;"><div id="contentBG" class="selectable">\n\n  \x3c!-- 页面重渲染插入代码结束 --\x3e\n\n  `+document.body.innerHTML+"\n\n        </div></s-scroll-view></div>\n\n    </s-drawer>\n\n  </s-page>\n\n";const page_root=document.getElementById("page_root"),UIt=document.getElementById("UIt"),link_a=document.createElement("a"),contentScroll=document.getElementById("contentScroll"),toTopBtn=document.getElementById("toTop"),title=document.querySelector("#contentBG > header > h1"),title_height=document.querySelector("#contentBG > header").offsetHeight-document.querySelector("#contentBG > header > h2").offsetHeight,appbar=document.getElementById("appbar"),contentBG=document.getElementById("contentBG"),timeElement=document.getElementById("time");var toTop_intervalID=-1;const img_dialog=document.getElementById("img_dialog"),img_dialog_img=document.getElementById("img_dialog_img"),img_dialog_p=document.getElementById("img_dialog_p");function getQueryString(e){let t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null}function msg(e,t,n){let o={};return o.root=document.querySelector("s-page"),o.text=e,o.action=null==t?"":t,null!=n&&(o.type="error"),customElements.get("s-snackbar").show(o),console.output("创建了新的Snakbar\n"+JSON.stringify(o)),o}function debug(e){return 1==e?(document.debugging=!0,msg("调试模式已启用","了解"),document.debugging):(0==e?(document.debugging=!1,msg("调试模式已禁用","了解")):document.debugging=!document.debugging,document.debugging)}document.debugging=!1,console.output=function(e){document.debugging&&console.log(e)};let localReg=/(127\.0\.0\.1)|(0\.0\.0\.0)|(localhost)/i;function scrollToTop(){window.location.hash="";var e=-contentScroll.scrollTop/80;-1==toTop_intervalID?(toTop_intervalID=setInterval(()=>{contentScroll.scrollBy(0,e),console.output("回顶循环#"+toTop_intervalID+"执行操作"),0==contentScroll.scrollTop&&(clearInterval(toTop_intervalID),console.output("回顶循环#"+toTop_intervalID+"操作完成"),toTop_intervalID=-1)},1),console.output("创建新的回顶循环句柄#"+toTop_intervalID)):e*=1.5}function setUItitle(e){UIt.innerHTML=e}function openURL(e,t){link_a.target=null!=t?"_self":"_blank",link_a.href=e,link_a.click()}function refreshAppbar(){contentScroll.scrollTop/title_height<=1.5&&(UIt.style="opacity:"+contentScroll.scrollTop/title_height+";",console.output("UItitle透明度改变")),contentScroll.scrollTop>=contentScroll.offsetHeight?"fadeIn"!=toTopBtn.className&&(toTopBtn.setAttribute("onclick","scrollToTop();"),toTopBtn.setAttribute("class","fadeIn"),toTopBtn.style="",console.output("显示回顶按钮")):"fadeOut"!=toTopBtn.className&&(toTopBtn.setAttribute("onclick","javascript:void(0);"),toTopBtn.setAttribute("class","fadeOut"),toTopBtn.style="display: none;",toTopBtn.style="",console.output("隐藏回顶按钮"))}if(localReg.test(window.location.href)&&(debug(!0),msg("检测到本地调试","了解")),null!=getQueryString("debug")&&(debug(!0),msg("检测到调试命令行","了解")),toTopBtn.addEventListener("animationend",e=>{"fadeOut"==toTopBtn.className&&(toTopBtn.style="display: none;")}),contentScroll.onscroll=function(){refreshAppbar()},setUItitle(title.innerHTML),console.output("设置UI标题\nUItitle.innerHTML="+title.innerHTML),document.getElementById("sidebar").style.height=`${document.body.scrollHeight-appbar.offsetHeight}px`,window.addEventListener("resize",()=>{document.getElementById("sidebar").style.height=`${document.body.scrollHeight-appbar.offsetHeight}px`}),document.getElementById("mdRender_config")){let e=document.getElementById("mdRender_config");if(!conf_sidebar_links_preventDefault&&Math.floor(e.dataset.sideshipHide)>=0){let t=document.getElementById("side_ship_"+Math.floor(e.dataset.sideshipHide));t.setAttribute("type","filled-tonal"),t.setAttribute("clickable","false"),t.setAttribute("onclick","void(0);"),console.output("Sidebar-btn被配置Div隐藏\nside_ship_"+Math.floor(e.dataset.sideshipHide))}e.hasAttribute("data-title")&&(setUItitle(e.dataset.title),console.output("UItitle被覆写\nUItitle.innerHTML"+e.dataset.title))}function RefreshCountup(e,t,n){let o=Date.now();end=new Date(e,t-1,n),ends=end.getTime();let i=ends-o,l=Math.floor(i/1e3),a=-1*Math.floor(l/60/60/24),s=-1*Math.floor(l/60/60%24),c=-1*Math.floor(l/60%60),r=-1*Math.floor(l%60);timeElement.innerHTML="<center><small>本站已建立"+a+"天"+s+"时"+c+"分"+r+"秒</small></center>"}if(conf_time[0]){var Timing_intervalID=setInterval(()=>{RefreshCountup(conf_time[1],conf_time[2],conf_time[3])},1e3);console.output("启用建站时长计时 loop#"+Timing_intervalID+`\nSince ${conf_time[1]}-${conf_time[2]}-${conf_time[3]}`)}else timeElement.remove();function selectAllTextInElement(e){let t=document.createRange();t.selectNodeContents(e);let n=window.getSelection();n.removeAllRanges(),n.addRange(t)}function copyBtnDone(e,t){console.output("CodeCopyBtn状态改变至「触发」"),e.setAttribute("type","filled-tonal");e.innerHTML;e.innerHTML=`<s-icon type="done" slot="start"></s-icon>${conf_codeCopyBtn_tip_done}`,setTimeout(()=>{e.setAttribute("type","elevated"),e.innerHTML=`<s-icon slot="start"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-240v-480 480Z"></path></svg></s-icon>${conf_codeCopyBtn_tip}`,t==window.getSelection().toString()&&(console.output("CodeCopyBtn状态改变时用户选中文本未改变，已清空"),window.getSelection().removeAllRanges()),console.output("CodeCopyBtn状态改变至「未激活」")},5e3)}function openImgView(e,t,n){img_dialog_img.src=e;let o=e.split("/").pop().split("\\").pop();img_dialog_p.innerHTML=t?`<b><big class="selectable">${t}</big></b><br><small>${o} | </small>`:`<b><big class="selectable">${o}</big></b><br>`;let i="";img_dialog_img.onload=function(){i=img_dialog_img.naturalHeight+"×"+img_dialog_img.naturalWidth,img_dialog_p.innerHTML+=`<small>${i} | 以<a href="${conf_licen_link}">${conf_licen}</a>协议提供</small><br><p class="selectable">${n}</p>`,console.output("imgView被打开\nimgsrc="+e+"\nimgFileName="+o+"\nimgTitle="+t+"\nimgInfo="+i)},img_dialog_img.onerror=function(){img_dialog_p.innerHTML+=`<small>无法获取图片信息 | 以<a href="${conf_licen_link}">${conf_licen}</a>协议提供</small><br><p class="selectable">${n}</p>`,console.output("imgView被打开\nimgsrc="+e+"\nimgFileName="+o+"\nimgTitle="+t+"\nimgInfo= [[获取失败]]")},img_dialog.show(),img_dialog.setAttribute("style","")}console.log("%cPages Markdown Re-Render v"+PluginVer[0]+"%c["+PluginVer[1]+"%c]\nCopyright (C) 2024 kdxiaoyi. All right reserved.","color:#90BBB1;","color:#90BBB1;","color:#90BBB1;"),conf_link_arrow&&document.querySelectorAll("a").forEach(e=>{if(conf_link_arrow_replace)return e.innerHTML=e.innerHTML.replace(/[\u2197\u0024(\ud83d\ude97)]/,conf_link_arrow_icon),void console.log("为a添加了外链图标 (替换模式)");/$#/.test(e.src)||"_blank"!=e.targe||(e.innerHTML+=conf_link_arrow_icon,console.log("为a添加了外链图标"))}),conf_codeCopyBtn&&document.querySelectorAll("code").forEach(e=>{if(0==e.querySelectorAll("span").length&&(!e.parentNode||"PRE"!==e.parentNode.nodeName))return;e.parentNode.parentNode.parentNode.style.margin="5px 0 5px 0",console.output("为Code添加CodeCopyBtn"),e.classList.add("processed");let t=document.createElement("s-chip");t.setAttribute("type","elevated"),t.setAttribute("class","font-default"),t.setAttribute("clickable","true"),navigator.clipboard||(t.setAttribute("clickable","false"),console.output("Clipboard API：不存在此方法")),t.innerHTML=`<s-icon slot="start"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-240v-480 480Z"></path></svg></s-icon>${conf_codeCopyBtn_tip}`,t.addEventListener("click",()=>{window.getSelection().removeAllRanges(),selectAllTextInElement(t.parentElement.querySelectorAll("code")[0]),navigator.clipboard.writeText(window.getSelection().toString()).then(function(){console.output("Clipboard API返回「✓已写入剪贴板」"),copyBtnDone(t,window.getSelection().toString())},function(){msg("没有授予剪贴板权限…","好",!0),console.output("Clipboard API返回「×无法写入剪贴板」")})}),e.parentNode.insertBefore(t,e.nextSibling)}),conf_copy_endnote&&(endnote=conf_copy_endnote.replace(/%LINK%/,window.location).replace(/%TITLE%/,UIt.innerHTML).replace(/%ETITLE%/,title.innerHTML),console.log("覆写复制操作处理\nendnote="+endnote),document.addEventListener("copy",async e=>{e.preventDefault();try{console.log("向复制文本末尾追加endnote\nOriginText="+window.getSelection().toString()),await navigator.clipboard.writeText(window.getSelection().toString()+endnote),msg("已复制文本，请注意授权协议。","好")}catch(e){console.log("无法复制文本: "+e),msg("复制失败，无法访问剪贴板。","好",!0)}})),document.getElementById("img_dialog_btn").addEventListener("click",()=>{img_dialog.setAttribute("style","display:none;"),img_dialog.dismiss(),console.output("imgView关闭")}),document.getElementById("img_dialog_open_btn").addEventListener("click",()=>{/ax1x\.com/.test(img_dialog_img.src)&&conf_imgView_imgse_noRes?openURL("https://imgse.com/i/"+img_dialog_img.src.split("/").pop().split(".")[0]):openURL(img_dialog_img.src),img_dialog.setAttribute("style","display:none;"),img_dialog.dismiss(),console.output("imgView关闭（查看原图）")}),conf_imgView_open||document.getElementById("img_dialog_open_btn").remove(),document.querySelectorAll("img").forEach(e=>{e.addEventListener("load",()=>{"error"!=e.dataset.status&&(contentBG.style.height="initial",contentBG.style.height=`${contentBG.offsetHeight+appbar.offsetHeight}px`,console.output("修改页面真实高度\ncontentBG.style.height="+contentBG.style.height))}),e.addEventListener("error",()=>{if("error"==e.dataset.status)return msg("坏链占位符图片加载错误，请联系站长处理","好",!0),void console.warn("错误：无法加载图片加载错误占位符图片。\n conf_img_error_replace="+conf_img_error_replace);e.dataset.status="error",e.src=conf_img_error_replace,console.output("某个图片加载失败\nsrc="+e.src)}),conf_imgView&&"true"!=e.dataset.uiImg&&(e.classList.add("processed"),conf_imgView_imgse?e.addEventListener("click",()=>{openImgView(e.src.replace(/\.md\./,"."),e.title,e.alt)}):e.addEventListener("click",()=>{openImgView(e.src,e.title)}),console.output("向img添加了imgView绑定"))}),contentBG.style.height=`${contentBG.offsetHeight+appbar.offsetHeight}px`,console.output("修改页面真实高度\ncontentBG.style.height="+contentBG.style.height),document.getElementById("old_menu")&&document.getElementById("old_menu").remove();